#!/usr/bin/env ruby
# encoding: utf-8

# A script for programmatically generating PSR and translation pages for php-fig.org

PSR_DIR  = File.join(File.dirname(__FILE__), '_includes', 'fig-standards', 'accepted')
EXTRAS   = ['meta', 'examples']
LANG_MAP = {
  :es => 'Spanish',
  :fr => 'French',
  :it => 'Italian',
  :sl => 'Slovenian',
}

raise 'Run "git submodule init"' unless File.directory?(PSR_DIR)

Dir["#{PSR_DIR}/*.md"].sort.each do |original|
  # Skip the meta and example files
  next if File.basename(original) =~ Regexp.new("-(#{EXTRAS.join('|')})\\.md$")

  # Skip non-PSR files?
  next unless File.basename(original) =~ /^PSR-(\d+)\b/

  num   = $1
  title = File.read(original).split(/[\n\r]/).first.sub(/^#\s*/, '')

  pages = [
    {
      :lang  => 'en',
      :name  => 'English (official)',
      :path  => "/psr/psr-#{num}",
      :title => "PSR-#{num} — #{title}",
      :disc  => false,
      :inc   => original.sub(%r{.*/fig-standards/}, 'fig-standards/'),
    }
  ]

  Dir["#{PSR_DIR}/*/PSR-#{num}*.md"].sort.each do |tr|
    lang  = File.basename(File.dirname(tr))
    title = File.read(tr).split(/[\n\r]/).first

    pages << {
      :lang  => lang,
      :name  => LANG_MAP[lang.to_sym],
      :path  => "/psr/psr-#{num}/#{lang}",
      :title => "PSR-#{num} — #{title}",
      :inc   => tr.sub(%r{.*/fig-standards/}, 'fig-standards/'),
    }
  end

  pages.each do |page|
    links = []
    pages.each do |other|
      links << " - name: #{other[:name]}"
      links << "   path: #{other[:path]}" unless other[:path] == page[:path]
    end

    File.open(".#{page[:path]}/index.md", 'w') do |f|
      f << <<-EOS.gsub(/^ {8}/, '')
        ---
        # This file is automatically generated by `_build`.
        layout:     psr
        title:      #{page[:title]}
        disclaimer: #{page[:lang] == 'en' ? 'false' : 'true'}
        translations:
        #{links.join("\n")}
        ---
        {% include #{page[:inc]} %}
      EOS
    end
  end
end
